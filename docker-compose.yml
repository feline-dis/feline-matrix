services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "8448:8448"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - registration-proxy
      - dendrite
      - livekit
      - lk-jwt-service
    restart: unless-stopped

  dendrite:
    image: ghcr.io/element-hq/dendrite-monolith:latest
    volumes:
      - ./config/dendrite.yaml:/etc/dendrite/dendrite.yaml:ro
      - ./scripts/dendrite-entrypoint.sh:/usr/local/bin/dendrite-entrypoint.sh:ro
      - dendrite_data:/data
    environment:
      - DATABASE_URI=${DATABASE_URI}
      - REGISTRATION_SHARED_SECRET=${REGISTRATION_SHARED_SECRET}
    entrypoint: ["/usr/local/bin/dendrite-entrypoint.sh"]
    restart: unless-stopped

  registration-proxy:
    build: .
    environment:
      - REGISTRATION_SHARED_SECRET=${REGISTRATION_SHARED_SECRET}
      - INVITE_CODE=${INVITE_CODE}
      - DENDRITE_URL=${DENDRITE_URL:-http://dendrite:8008}
    depends_on:
      - dendrite
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    environment:
      - "LIVEKIT_KEYS=${LIVEKIT_KEY}: ${LIVEKIT_SECRET}"
    ports:
      - "7881:7881/tcp"
      - "50000-50200:50000-50200/udp"
    volumes:
      - ./livekit/livekit.yaml:/etc/livekit.yaml:ro
    restart: unless-stopped

  lk-jwt-service:
    image: ghcr.io/element-hq/lk-jwt-service:latest
    environment:
      - LIVEKIT_URL=wss://ohana-matrix.xyz/sfu
      - LIVEKIT_KEY=${LIVEKIT_KEY}
      - LIVEKIT_SECRET=${LIVEKIT_SECRET}
      - LK_JWT_PORT=8080
      - LIVEKIT_FULL_ACCESS_HOMESERVERS=ohana-matrix.xyz
    depends_on:
      - livekit
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
  dendrite_data:
